\documentclass[numberedappendix]{emulateapj}
%\documentclass[iop]{emulateapj}
%apj gives the referee version/preprint2
%\usepackage[T1]{fontenc}
%\usepackage[utf8]{inputenc}
%\usepackage{graphicx}
%\usepackage{natbib}
\usepackage{amsmath}
\usepackage{amssymb}
%\usepackage{vmargin}
%\usepackage{pdfpages}
\usepackage{aas_macros}
\usepackage[normalem]{ulem}
\usepackage[usenames]{color}
\definecolor{DarkGreen}{rgb}{0.64,0.80,0.35}
\newcommand\ALc[1]{{\color{red} \bf #1}} %Astrid
\newcommand\Ac[1]{{\color{green} \bf #1}} %% Avery
\newcommand\Pc[1]{{\color{cyan} \bf #1}} %% Phil
\newcommand\Cc[1]{{\color{blue} \bf #1}} %% Christoph
\newcommand\Ec[1]{{\color{magenta} \bf #1}} %% Ewald
\begin{document}
\title{How uniform is TeV-blazar heating?}
\author{Astrid Lamberts$^1$, Philip Chang$^1$, Ewald Puchwein$^2$, Christoph Pfrommer$^3$, Avery E. Broderick$^{4,5}$ and Mohamad Shalaby$^{2,3,6}$}
\affil{$^1$ Department of Physics, University of Wisconsin-Milwaukee, 1900 East Kenwood lowBoulevard, Milwaukee WI 53211, USA}
\affil{$^2$ Institute of Astronomy and Kavli Institute for Cosmology, University of Cambridge, Madingley Road, Cambridge, CB3 0HA, UK}
\affil{$^3$ Heidelberg Institute for Theoretical Studies, Schloss-Wolfsbrunnenweg 35, D-69118 Heidelberg, Germany}
\affil{$^4$ Perimeter Institute for Theoretical Physics, 31 Caroline Street North, Waterloo, ON, N2L 2Y5, Canada}
\affil{$^5$ Department of Physics and Astronomy, University of Waterloo, 200 University Avenue West, Waterloo, ON, N2L 3G1, Canada}
\affil{$^6$ Department of Physics, Faculty of Science, Cairo University, Giza 12613, Egypt}
\email{lambera@uwm.edu}
\begin{abstract}
TeV-blazar  heat the intergalactic medium (IGM) as their gamma rays interact with photons of the extragalactic background light to produce electron-positron pairs, which lose their kinetic energy to the surrounding medium through plasma instabilities. Assuming uniform heating, this mechanism increases the temperature of the IGM and produces an inverted temperature-density relation in underdense regions. This additional heating source significantly impacts large scale structure formation. In this paper we go beyond the approximation of uniform heating and quantify the heating rate fluctuations and their impact on the thermal history of the IGM. We analytically compute a filtering function that relates the heating rate fluctuations to the underlying dark matter density field. We implement it in the cosmological code GADGET-3 and perform large scale simulations to determine the impact of inhomogeneous heating. We show that, because of the bias, blazar heating is inhomogeneous, at all redshifts. The temperature-density relation shows an important scatter and presents a low temperature envelope of unheated regions, in particular at low densities and within voids. However, the median temperature of the IGM is close to that in the uniform case, albeit slightly lower at low redshift. We find that blazar heating is more complex than initially assumed and that the temperature-density relation is not unique. Our analytic model for the heating rate fluctuations couples well with large scale simulations and provides a cost-effective alternative to subgrid models.
\end{abstract}
\keywords{BL Lacertae objects: general, cosmology: theory, gamma-rays: general, intergalactic medium, large-scale structure of universe}
\section{Introduction}
The intergalactic medium constitutes the bulk of the baryons forming the cosmic web \citep{1996Natur.380..603B} as well as the reservoir of baryons available for the formation of galaxies and clusters \citep{1997ApJ...489....7R}. Observations of metal-enriched gas (see e.g. \citet{2009A&A...493..409S,2010MNRAS.407.2063W}) link its evolution to the formation of galaxies. Therefore, the thermal history of the IGM plays a central role in determining the development of structure in the visible universe.

The temperature of the IGM is mostly set by photoionization of hydrogen and helium, competing with adiabatic cooling. As a result, the universe is slowly cooling once reionization is completed. The IGM temperature is expected to increase with density because denser regions experience a lower amount of adiabatic cooling, as well as more recombination-induced photoheating. Gas in the IGM that has not been shock heated provides a lower envelope to the temperature-density distribution.  \ALc{Observations of Lyman $\alpha$ absorption lines with $4\leqslant z \leqslant 2$ show that lower column density gas presents a lower envelope for the linewidth distribution, which is commonly interpreted as a an indication that lower density gas is colder than high density gas \citep{2000MNRAS.318..817S,2000ApJ...534...41R,2012ApJ...757L..30R}. A temporary flattening of the slope of the inferred temperature-density relation around $z\sim 3$ indicate an additional source of heating at that redshift.}\ALc{\sout{Observations of Lyman $\alpha$ absorption lines in the spectra of background quasars due to neutral gas confirm the positive slope of the temperature-density relation \citep{2000MNRAS.318..817S,2000ApJ...534...41R,2012ApJ...757L..30R} with only a temporary flattening around $z\sim 3$. }}

The latter is expected due to He\,\textsc{ii} reionization \citep[e.g.][]{2009ApJ...694..842M,2013MNRAS.435.3169C,2014arXiv1410.1531P}. However, recent measurements found that underdense regions may be warmer than predicted \citep{2009MNRAS.399L..39V,2008MNRAS.386.1131B}, as well as unexpectedly high temperatures at $z<2$ \citep{2014MNRAS.441.1916B}. Although an inverted temperature-density relation in underdense regions has not been firmly established yet \citep{2014MNRAS.438.2499B}, these observations suggest the thermal history of the IGM may be more complex than initially assumed.

\citet{2012ApJ...752...22B} recently suggested a complementary heating mechanism, through TeV blazars. TeV blazars are active galactic nuclei (AGN) emitting very high energy gamma rays ($E\ge100$~GeV). They belong to the radio-loud subgroup of AGN, with the relativistic jet being pointed towards us. About 50 of these sources have been significantly discovered so far (http://tevcat.uchicago.edu/) by ground based Cerenkov telescopes such as MAGIC, H.E.S.S. and VERITAS. Those pointed observations have only skimmed the surface of a much larger population that manifest themselves as hard-spectra gamma-ray blazars as observed with the space-based \textit{Fermi}-LAT telescope \citep{2014ApJ...790..137B}. 

The universe is mainly opaque to very high energy gamma rays, which interact with the extragalactic background light (EBL) producing electron/positron pairs \citep{1967PhRv..155.1408G,1992ApJ...390L..49S}. It is commonly assumed that the electron/positron pairs upscatter photons of the cosmic microwave background, resulting in a distribution of photons with energies between $0.1$ and $100$ GeV. Such an emission component towards TeV blazars has not been observed so far \citep{2010A&A...524A..77A}, despite extended searches \citep{2014A&A...562A.145H}. One solution would be pair deflection due to the intergalactic magnetic field, thus lowering the surface brightness of the formed pair halo at GeV energies \citep{2013A&ARv..21...62D,2012ApJ...747L..14V,2011ApJ...733L..21D}. 

However, the cascaded GeV emission would still contribute to the extragalactic gamma-ray background (EGRB). \textit{Fermi}-LAT was able to resolve more sources than its predecessor EGRET, thereby limiting the isotropic component of the unresolved EGRB and severely constraining the redshift evolution of hard blazars in the presence of inverse Compton cascades \citep[e.g.,][]{Vent:10,Murase:2012,Inoue:2012}. As a result of these, it is now well established that in this picture, the co-moving number density of gamma-ray blazars, and by extension the TeV blazars, must either be constant or decreasing with redshift \citep{Knei-Mann:08,Vent:10,Abazajian:2011,Inoue:2012}.  \ALc{This lies in stark contrast to other classes of AGNs specifically}, and all other tracers of the cosmological history of accretion onto galactic halos generally (e.g., star formation).  \ALc{Furthermore, after careful modeling of gamma-ray and X-ray survey selection effects there appears to be no evidence for a significantly} different evolution of blazars in comparison to their radio-loud analogues such as radio galaxies \citep{Giommi:2012,Giommi:2013}.\ALc{ Together this casts doubt on the inverse Compton cascade picture and provides circumstantial evidence} that pair beams instead transfer their energy directly to the IGM through plasma instabilities \citep{2012ApJ...752...22B, 2012ApJ...758..102S, 2013ApJ...777...49S,2014arXiv1410.3797C}. This naturally explains the EGRB with a blazar population that exhibits a redshift evolution in agreement with that of quasars \citep{2014ApJ...790..137B,2013arXiv1308.0015B}.

%This manifests the inherent inconsistency of the inverse Compton cascade  picture, which implies that the TeV blazar population cannot exhibit the dramatic evolution that is seen in other classes of AGNs specifically, and other tracers of the cosmological history of accretion onto galactic halos more generally (e.g., star formation). Carefully modeling the selection function of blazars, there appears to be no evidence for a significantly different evolution of blazars in comparison to their radio-loud analogues such as radio galaxies \citep{Giommi:2012,Giommi:2013}. This provides circumstantial evidence that pair beams instead transfer their energy directly to the IGM through plasma instabilities \citep{2012ApJ...752...22B, 2012ApJ...758..102S, 2013ApJ...777...49S,2014arXiv1410.3797C}. This naturally explains the EGRB with a blazar population that exhibits a redshift evolution in agreement with that of quasars \citep{2014ApJ...790..137B,2013arXiv1308.0015B}.

The pairs constitute a dilute, ultrarelativistic beam, which is subject to several plasma instabilities, from which the ``oblique'' instability \citep{PhysRevE.70.046401} is the most powerful. Assuming its efficiency in the linear regime extends to the non-linear regime, \citet{2012ApJ...752...23C} show it is responsible for increasing the temperature of the IGM by almost a factor 10 in low density regions. While this assumption is still debated (see \citet{2013ApJ...770...54M,2014ApJ...787...49S} but also \citet{2013ApJ...777...49S,2012ApJ...758..102S,2014arXiv1410.3797C}), throughout all this paper we will assume plasma instabilities are the dominant mechanism for cooling of the pair beams.

Including TeV blazar heating in the thermal history of the IGM, \citet{2012ApJ...752...23C} were able to reproduce the inverted temperature-density relation for low density regions. \citet{2012ApJ...752...24P} found that TeV blazar heating  creates a redshift dependent entropy floor in clusters and galaxies, thus suppressing the formation of dwarf galaxies after the peak of blazar activity at redshift $z\simeq2$ and potentially providing an explanation to the ``missing satellite problem'' and the ``missing void dwarf problem'' \citep{2010AdAst2010E...8K}. Implementing uniform blazar heating, i.e. with a redshift-dependent but spatially homogeneous energy deposition rate per unit volume, in a cosmological hydrodynamical simulation of galaxy formation, \citet{2012MNRAS.423..149P} find excellent agreement with the one and two-point statistics of the Ly$\alpha$ forest, which is the main observational tracer of low density regions in the universe.

However, the low thermal broadening of certain Lyman $\alpha$ lines indicates the presence of cold gas \ALc{at $z =2.4$} \citep{2012ApJ...757L..30R}, which suggests TeV blazar heating does not uniformly heat the whole universe. It is natural to expect a larger TeV flux close to higher density regions where visible structures form. Conversely, in large underdense regions, far from massive black holes, heating is probably much lower. The goal of this paper is to go beyond the hypothesis of uniform heating and to link TeV blazar heating to the underlying clustered density field and take into account the bias of sources. This will lead to a more heterogeneous heating pattern and account for unheated regions while keeping the overall impact of blazar heating.

Self-consistently studying the evolution of the IGM from first principles involves modeling both the formation and evolution of galaxies at the largest scales of the universe. As this is still far beyond reach of current computers, we have determined a filter function which relates the heating fluctuations to the dark matter structure similarly to \citet{2007MNRAS.376.1680P,2005ApJ...626....1B,2014PhRvD..89h3010P}. Based on the hierarchical structure formation in a $\Lambda$CDM universe, it naturally selects the relevant length scales for TeV blazar heating ($\S$2). We have implemented it in large scale cosmological simulations ($\S$3) in order to focus on the equation of state and thermal evolution of the IGM ($\S$4). We then discuss how inhomogeneous heating could reconcile different observations ($\S$5) and conclude ($\S$6).

\section {Determining the window function}\label{window}
\subsection{Intuitive understanding}
One zone models \citep{2012ApJ...752...23C,2012ApJ...752...24P} and numerical simulations \citep{2012MNRAS.423..149P} of blazar heating on the IGM assume that the heating is uniform. Because the heating rate depends on the local density of EBL and TeV photons, the assumption of uniform heating implies that the distributions of EBL and TeV photons are uniform. For EBL photons, this is likely the case, as the mean free path is larger than the Hubble length. However, for TeV photons the mean free path compares with the separation between TeV sources for $z\geqslant$ 1, so the {\it spatial} fluctuations in the heating rate are likely nontrivial. Moreover, the sources of TeV photons tend to be clustered and so the IGM near these clustered regions will get an increased flux of photons in comparison to low-density regions because of the increased number of sources and the $1/r^2$ flux dilution with increasing distance $r$ from the source.

Our goal is to include a more realistic model for heating due to TeV blazars in numerical simulations.
To properly calculate the heating fluctuations due to TeV blazar heating, the formation and evolution of accreting supermassive black holes must be modeled in a full self-consistent cosmological simulation. In addition, the TeV radiation from these systems must be ray-traced through the simulation volume. Such a task is computationally intractable. As a result, we have elected to model this TeV blazar heating in a statistical manner.

We assume that TeV blazars are associated with galaxies and that they roughly emit over $4\pi$ steradian. The latter assumption remains valid as long \ALc{as the duty cycle of blazars is small enough so that jets point in all directions over cosmological timescales and} the number of TeV blazars is large enough such that every spot in the universe is illuminated by at least a few TeV blazars, which is the case for $z\lesssim 6$ \citep{2012ApJ...752...23C}.
The heating rate at a given point $\mathbf{x}$ is determined by the received TeV flux from all the sources within a certain radius $r_{\mathrm{max}}$, where $r_{\mathrm{max}}$ is much larger than the mean free path of gamma rays.
\begin{equation}
\label{eq:heating_rate}
%\dot{Q}(\mathbf{x},z)= \frac{1}{4\pi} \int_{\Omega}\int_0^{r_{\mathrm{max}}} \mathcal{E}(\mathbf{r}'+\mathbf{x},z)\sigma n_{\mathrm{EBL}}(z) e^{-\tau}dr' d\Omega,
\dot{Q}(\mathbf{x},z)= \frac{1}{4\pi} \int_{\Omega} d\Omega\int_0^{r_{\mathrm{max}}} dr'\frac{\mathcal{E}(\mathbf{r}'+\mathbf{x},z)}{D_{\mathrm{pp}}(z)} e^{-\tau},
\end{equation}
where $\dot{Q}$ and $\mathcal{E}$ are the heating rate density and emissivity of the sources (both in units of energy per unit time and per unit volume), $D_{\mathrm{pp}}$ is the mean free path for pair production on the EBL and $\tau$ is the associated optical depth along the line of sight.
%$\sigma$ (in cm$^{-2}$) is the energy-averaged cross section for pair production on the EBL and $\tau$ is the associated optical depth along the line of sight.

One can then express the resulting heating rate as a mean value $\bar{\dot{Q}}$ and a first order correction $\delta_H$.
\begin{equation}
\label{eq:delta_h}
\dot{Q}(\mathbf{x},z)=\bar{\dot{Q}}(\mathbf{x},z)\left[1+\delta_H(\mathbf{x},z)\right].
\end{equation}
The method is based on a Taylor expansion of the quantities describing the TeV sources and keeping only the first order corrections. Transforming to Fourier space yields for the fluctuation amplitude
\begin{equation}
\label{eq:use_window}
\tilde{\delta}_H(k,z)=\tilde{W}_H(k,z)\tilde{\delta}(k,z),
\end{equation}
where $\tilde{W}_H$ is defined as the window function and maps the Fourier transform of the dark matter overdensity, $\tilde{\delta}$, to the Fourier transform of the heating fluctuations, $\tilde{\delta}_H$. This naturally yields the relevant length scale for heating rate fluctuations. %\Cc{[{\em Does $\delta$ refer to gas or DM overdensity? In Sect 3.1, you talk about a gas overdensity\ldots}]}
The detailed exposition of this method, in the Newtonian limit and in an expanding universe, is given in Appendix A. In the following section, we present the general method and highlight the underlying hypotheses of our work.
\subsection{Window function for TeV blazar heating}\label{sec:window}
To determine the heating rate fluctuations we express the TeV emissivity in Eq.~\eqref{eq:heating_rate} as a mean value and a first order correction. The heating rate at a given point is set by the received TeV flux from all the sources within a certain radius. We assume that the pairs lose their energy to the IGM at the point where they are created. As stated in \citet{2012ApJ...752...22B}, this is a reasonable assumption as the plasma instability length scales are smaller than the mean free path of these TeV photons.

The TeV gamma rays are emitted by accreting supermassive black holes at centers of galaxies, which cluster in overdense regions. Matter is tightly coupled to the underlying dark matter, the evolution of which is straight forward to model analytically within the linear approximation. The linear approximation is valid as long as the overdensity is small, which is true in the early universe and then breaks down at small scales as very dense structures form. Our computation takes into account the bias between baryonic matter and dark matter \citep{1996MNRAS.282..347M}, as we detail below.

To model cosmic distances, Eq.~\eqref{eq:heating_rate} is integrated in redshift space and we take into account the resulting energy loss for the TeV photons as well as first order corrections due to proper motions of the sources within the Hubble flow \citep{1987MNRAS.227....1K}. We integrate over the energy distribution of the TeV-emission. We thus get
\begin{eqnarray}
\label{eq:window}
\tilde{W}_H(k,z)&=&\frac{1}{\bar{X}}\int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}}dE\int_z^{z_{\mathrm{max}}}dz'\frac{dX(E,z,z')}{dz'} \\
&&\times \frac{D(z')}{D(z)}\left((b(z)+1)j_0(kr)-\frac{2}{3}j_2(kr)\right), \nonumber
\end{eqnarray}
with
\begin{equation}
\label{eq:define_X}
X(E,z',z)=\frac{\mathcal{E}(E',z') e^{-\tau(z,z',E)}}{H(z') D_{\mathrm{pp}}(E',z')}.
\end{equation}
with $r$ the comoving distance between the source and heated region, $\bar{X}$ its spectral average and $D$ denotes the linear growth factor defined in Eq.~\eqref{eq:growth_1}. $E$ is the energy of the received TeV photon, $E'$ its initial energy and $\mathcal{E}$ the (comoving) blazar luminosity density, $r$ the comoving distance between the source and heated region, $b$ is the bias and $j_0$ and $j_2$ are spherical Bessel functions.

Assuming the TeV blazar distribution follows the redshift evolution of quasars, \citet{2012ApJ...752...23C} determined the blazar luminosity density in the TeV band based on a fit to \citet{2007ApJ...654..731H}
\begin{eqnarray}
\label{eq:mean_heat}
\mathcal{E}(E',z)&=&\mathcal{E}(E',z=0)\Phi_{B}(z)\\ \nonumber
&\simeq& \mathcal{E}(E',z=0)\zeta\Phi_{Q}(z),
%&\simeq& \zeta\epsilon(E',z=0)10^{-.0037(1+z)^4+.085(1+z)^3-.0778(1+z)^2+2.795(1+z)-2.133}
\end{eqnarray}
with $\zeta=2.1\times 10^{-3}$ and
\begin{equation}
\label{eq:phi_quasar}
\Phi_{Q}[x(z)]=10^{-0.0037x^4+0.085x^3-0.0778x^2+2.795x-2.133},
\end{equation}
where $x=1+z$.
As TeV blazars have power-law spectra with intrinsic (i.e. redshift corrected) spectral index $\alpha$, we get
\begin{equation}
\label{eq:blaz_lum}
\mathcal{E}(E',z=0)=\mathcal{E}(E_0,z=0)\left(\frac{E'}{E_0}\right)^{-\alpha}\equiv \mathcal{E}_0\left(\frac{E'}{E_0}\right)^{-\alpha},
\end{equation}
with $\mathcal{E}_0=(1.7-4.8)\times 10^{-36}$erg s$^{-1}$ cm$^{-3}$ the current blazar luminosity density. Using 28 TeV blazars, \citet{2012ApJ...752...23C} find that $\alpha\simeq 3$ and $E_0\simeq $ 1 TeV. Adopting typical parameters of nearby TeV blazar spectra yields $E_{\mathrm{min}}=100$ GeV, and $E_{\mathrm{max}}=10$ TeV. Assuming blazars follow a similar evolution to quasars, we use $z_\mathrm{max}=5$ \citep{2007ApJ...654..731H}.

The optical depth is set by the mean free path $D_\mathrm{pp}(E',z)$ of TeV photons before they interact with an EBL photon to produce an electron-positron pair. Its redshift evolution is set by the EBL. Despite careful work that aims at constraining it, there remain uncertainties in the star formation history of the universe as well as its metallicity and dust contents (see e.g \citet{2008A&A...487..837F,2006ApJ...648..774S}). Following \citet{2012ApJ...752...23C} we use a prescription
\begin{equation}
\label{eq:mean_free_path}
D_{\mathrm{pp}}(E',z')=35\left(\frac{E'}{1~\textrm{TeV}}\right)^{-1} \left(\frac{1+z}{2}\right)^{-\xi}~\textrm{Mpc,}
\end{equation}
where $\xi=4.5$ for $z<1$ and $\xi=0$ for $z>1$ \citep{2004A&A...413..807K,2009PhRvD..80l3012N}. The proper mean free path is constant for $z\geq 1$, however, the comoving mean free path increases for increasing redshift.

The fluctuations in TeV flux are related to the distribution of blazars, which is biased with respect to the distribution of dark matter halos. Luminous structures such as galaxies preferentially populate the high peaks of the dark matter density distribution. The bias of a structure is the ratio between its power spectrum to the power spectrum of the dark matter halos (see e.g. \citet{2002PhR...372....1C} for a review). It is stronger for more massive objects, such as the host galaxies of quasars.
Due to the small number of sources and TeV photon absorption, there is no observation of TeV blazar bias.  Therefore, we  use a model for quasar bias as well as a model for galaxy bias to illustrate the impact of the uncertainty on the value of the bias.  TeV blazars may have a stronger bias than quasars, as radio-loud AGN are generally found in a more clustered environment than quasars \citep{2009MNRAS.393..377M,2012MNRAS.421.3060S}. Our model for quasar bias is based on a fit of data by \citet{2005MNRAS.356..415C,2007ApJ...658...85M,2007AJ....133.2222S}. We use

  \begin{equation}
    \label{eq:qso_bias}
    b_{\mathrm{quasar}}(z)=10^{0.27z-0.04},
  \end{equation}
which is very similar to \citet{2012MNRAS.422..106P}. Our model for galaxy bias is based on a fit of data by \citet{2005A&A...442..801M,1998ApJ...492..428S,2006ApJ...637..631K}. We use
  \begin{equation}
    \label{eq:qso_bias}
    b_{\mathrm{galaxy}}(z)=10^{0.174z}.
  \end{equation}
Figure~\ref{fig:bias} shows the corresponding evolution of quasar and galaxy bias as a function of redshift. Using the same data, \citet{2008ApJ...678..627B} find that the quasar and galaxy bias can be fitted using a dark matter halo model of  $10^{13}h^{-1}M_{\odot}$ and $10^{12}h^{-1} M_{\odot}$ respectively. 

%\sout{An estimate can be obtained from the observations of quasar bias \citep{2005MNRAS.356..415C,2007ApJ...658...85M,2007AJ....133.2222S}. We use a fit to an analytic model for a halo mass of$10^{13}h^{-1}M_{\odot}$ \citep{2008ApJ...678..627B}. TeV blazars may have a stronger bias, as radio-loud AGN are generally found in a more clustered environment than quasars. To illustrate the impact of the uncertainty on the bias, we also use a model for galaxy bias, based on a halo mass of $10^{12}h^{-1} M_{\odot}$, for comparison.}}
%\Cc{[{\em Show additional figure with b(z) and fitting function.}]}

\begin{figure}[h]
\centering
% \includegraphics[width = .45\textwidth ]{window_gal_qso}
\includegraphics[width = .4\textwidth ]{bias}
\caption{Galaxy (red line) and quasar (green line) bias models used in our simulations.}
\label{fig:bias}
\end{figure}

Substituting Eqs.~\eqref{eq:mean_heat} and \eqref{eq:mean_free_path} into Eq.~\eqref{eq:window} then gives the complete window function for TeV blazar heating. Figure~\ref{fig:window} shows the filter for $z=1,2$ and 4 for a model with galaxy and quasar bias. We have computed the window function using an embedded Runge-Kutta method which is able to capture the fast variation of the Bessel functions at large wave numbers while decreasing computing time at smaller wave numbers.

\begin{figure}[h]
\centering
% \includegraphics[width = .45\textwidth ]{window_gal_qso}
\includegraphics[width = .45\textwidth ]{window_gal_qso}
\caption{Window function for TeV blazar heating from $z=1$ (solid lines), $z=2$ (dashed lines) and $z=4$ (dotted lines) for the galaxy bias model (red) and the quasar bias model (green).}
\label{fig:window}
\end{figure}
The window function describes how density fluctuations translate into heating fluctuations.The quasar bias model has more power at all scales because of the larger bias. Comparison with Fig.~\ref{fig:window_nobiases} (in the Appendix), computed without bias, shows that bias is responsible for values above unity in the window function. In the galaxy-bias model, at high redshift, most of the power resides on large scales, where blazar heating traces the density fluctuations. At smaller scales, density fluctuations have no impact and blazar heating is uniform. At the current epoch, TeV blazar heating in the galaxy-bias model is close to uniform as there is power only at the largest scales (above 100 Mpc), where the Universe is essentially uniform (see \citet{2013MNRAS.429.2910C} and references therein). In the quasar-bias model, there is comparably more power at small scales due to the larger bias and small-scale density fluctuations will lead to enhanced heating. In both models, the window function remains positive at all scales; thus, underdense regions are the only areas where a lower than average heating rate is expected. Heating at rates larger than the average is possible for large-scale overdensities but also on small scales for highly non-linear objects with $\delta\gg1$. We caution that our simplified approach with a linear bias description starts to break down there and would have to be augmented with a non-linear description of bias. However, the gas in these regions experiences shock heating in addition to photoheating such that the influence of blazar heating becomes negligible there. Moreover, those densities have little influence on the statistics of the high-redshift Lyman-$\alpha$ forest and thus shall not be the subject of the present work. After these first analytic estimates, we include the window function to model TeV blazar heating in cosmological simulations.

\section{Numerical method}
\subsection{Cosmological simulations}
We perform simulations with the smoothed particle hydrodynamics (SPH) code \textsc{GADGET-3}, an upgraded version of the publicly available \textsc{GADGET-2} code \citep{2005MNRAS.364.1105S}. The code solves the gravitational evolution of both dark matter and gas particles following a TreePM N-body method. The hydrodynamical evolution of the gas is modeled using an entropy conserving scheme \citep{2002MNRAS.333..649S}.

The cosmological model is based on the \textit{WMAP} 7-year data \citep{2011ApJS..192...18K}: $\Omega_M=0.272$, $\Omega_{\Lambda}=0.728$, $\Omega_{B}= 0.0465$, $h=0.704$ and $\sigma_8=0.809$. The initial conditions were evolved from $z=100$ until $z=1$ in boxes with comoving side length of 100 $h^{-1}$ Mpc and periodic boundary conditions. We use $N= 2\times 512^3$ particles, which gives a mass of $m_\mathrm{gas}=3.8\times10^{6} h^{-1} M_{\odot}$ and $m_\mathrm{DM}=1.8\times 10^{7} h^{-1} M_{\odot}$ for baryonic and dark matter particles, respectively. We used a gravitational softening length of 7.8 $h^{-1}$ kpc. We checked that the resolution has limited impact on the results of our simulations, performing test simulations with a comoving side length of 50 $h^{-1}$ Mpc. Increasing the resolution significantly broadens the temperature distribution of the gas for $N\leqslant 2\times 128$. However, there is a less than $2\%$ difference in the median temperature and less than $8\%$ difference in its root mean square (at $\delta_{\mathrm{gas}}=0$) between $N=2\times 128$ and $2\times 256$, indicating numerical convergence.

As we are only interested in the low density intergalactic medium, we use a simplified model for star formation which significantly speeds up the simulations. In this model, gas particles with $\delta_{\mathrm{gas}}\geq 1000$ and T $\leq 10^5$ are directly converted into stars \citep{2004MNRAS.354..684V}. Although it results in unrealistic galaxy properties, this approximation does not affect regions with $\delta_{\mathrm{gas}} \leq 0$. Local black hole feedback is not included. Photoheating is set by ionization equilibrium in the presence of an external UV field, which is parameterized according to \citet{2009ApJ...703.1416F}. As our version of the \textsc{GADGET-3} code assumes ionization equilibrium when computing photoheating rates, the heating is rather inefficient during reionization where this assumption is not well satisfied \citep[see e.g.][]{2014arXiv1410.1531P}. Following \citet{2012MNRAS.423..149P} we thus include the equivalent heat input by hand at redshift $z=10$.

The size of the box is set to model the heating perturbations on the scales determined by the window function in Fig.~\ref{fig:window}. We want to model a representative cosmic sample and probe distances beyond the mean free path of the TeV photons, which is of order of 35 (comoving) Mpc at $z=0$ (but 100 Mpc at $z=2$). To confirm that 100 $h^{-1}$ Mpc is a satisfactory size to model all the significant length scale, we performed a $L_\mathrm{box}=200 $ $h^{-1}$ Mpc simulation with $512^3$ particles. We compared the resulting temperature distribution function with the 100 $h^{-1}$ Mpc box, with the same mass resolution. It differs by less than $2\%$ for $z\geqslant 3$. For lower redshift, the temperature distribution is slightly wider in the larger box, but the difference remains below $10\%$ at $z=1$. This is consistent with studies showing that the one-and two-point statistics of the Lyman $\alpha$ forest are well captured with $\simeq 50$ $h^{-1}$ boxes \citep{2007MNRAS.374..196R,2009MNRAS.398L..26B}.
\subsection{Including the TeV blazar heating fluctuations}
We model the impact of the fluctuations in TeV blazar heating on the thermodynamics of the IGM. For every gas particle, the blazar heating is set by the mean value plus some correction depending on the local density field (Eq.~\eqref{eq:delta_h}). As in \citet{2012MNRAS.423..149P}, we adopt the mean heating rate computed by \citet{2012ApJ...752...23C} (Eq.~\eqref{eq:mean_heat}). We focus on the model with ``intermediate'' values for the blazar heating.

Modeling fluctuations by implementing a filtering function in a large scale simulation is a new method. The computation of the fluctuations is done in Fourier space and is inspired by the resolution of the Poisson equation. The Fourier transforms are performed with the parallel extension of the Fast Fourier Transform Library. The first step is map the particles onto a mesh, which is done with a clouds-in-cells algorithm \citep{1981csup.book.....H}. We determine the Fourier transform of the DM density field. Then the density field is multiplied by the window function performing a bilinear interpolation of tabulated values for certain values of redshift and wavenumber. In this paper we use 21 equally spaced redshift bins from $z=5$, where blazar heating turns on in our model, until the end of the simulation. We use 128 logarithmically equally spaced wavenumber bins. Similarly to the resolution of the Poisson equation, we deconvolve for the clouds-in-cells kernel by dividing by $\mathrm{sinc}^2(k_x L/2N)\mathrm{sinc}^2(k_y L/2N)\mathrm{sinc}^2(k_z L/2N)$. We then perform the inverse Fourier transform and renormalize. The last step is necessary to remap the results onto the gas particles.
\section{Results}
\begin{figure*}
\centering
\includegraphics[width = .45\textwidth ]{data_rho_z3_qso4.png}
\includegraphics[width = .45\textwidth ]{data_rho_z1_qso4.png}
\includegraphics[width = .45\textwidth ]{data_delta_z3_gal2.png}
\includegraphics[width = .45\textwidth ]{data_delta_z1_gal2.png}
\includegraphics[width = .45\textwidth ]{data_delta_z3_qso4.png}
\includegraphics[width = .45\textwidth ]{data_delta_z1_qso4.png}
\caption{ Slices through the midplane of the box, for $z=3$ (left column) and $z=1$ (right column) : logarithm of the density with respect to the mean value (upper row), heating rate fluctuations with the galaxy (middle row) and quasar model (lower row). }
\label{fig:slice}
\end{figure*}
\begin{figure*}
\centering
\includegraphics[width = .45\textwidth ]{data_U_z3_gal2.png}
\includegraphics[width = .45\textwidth ]{data_U_z1_gal2.png}
\includegraphics[width = .45\textwidth ]{data_U_z3_qso4.png}
\includegraphics[width = .45\textwidth ]{data_U_z1_qso4.png}
\caption{Ratio between the internal energy when blazar heating is included and when it is not, as a function of overdensity. The plots show the galaxy bias model (top) and the quasar bias model (bottom) for $z=3$ (left) and $z=1$ (right).}
\label{fig:heating_ratio}
\end{figure*}
Figure~\ref{fig:slice} shows the heating rate fluctuations in the midplane of the $L_x=100h^{-1}$ Mpc simulation for $z=3,1$ for both the galaxy and quasar bias model. Both simulation models are started from identical initial condition such that any visible difference is solely due to the different bias assumptions in the blazar heating model. The corresponding density field is shown in the upper column and shows increasing structure formation as the redshift decreases. The heating map has a linear scale while the density scale is logarithmic. The heating rate fluctuations are, on average, much smaller than the density fluctuations. This is because the window function filters out small scales, which correspond to collapsed regions, where density fluctuations are the highest. To the zeroth order, one can thus consider TeV blazar heating to be uniform, as was assumed in \citet{2012ApJ...752...23C}.

Additional heating (i.e. $\delta_H>0$) occurs around clustered regions. This is expected, as the window function translates large scale density fluctuations into heating rate fluctuations. Conversely, underdense regions, such as the one around $\{x=60,y=70\}$ (for $z=3$) display heating below average as they are isolated from sources, and their flux decreases as $r^{-2}$. As the redshift decreases, heating rate fluctuations increase, following increasing density fluctuations.

Figure~\ref{fig:heating_ratio} shows the volume weighted ratio of the full internal energy when blazar heating is included to the internal energy when blazar heating is not included as a function of the overdensity. These maps clearly highlight that blazar heating has more impact in underdense regions, as the heating rate per baryon is higher. Even if these regions receive less heat than regions with higher density (see Fig.~\ref{fig:slice}),  blazar heating can increase the internal energy by almost two orders of magnitude at $z=1$. This effect increases with time, as structures grow, the dense regions get denser and the voids get less dense. 

The impact of inhomogeneous heating translates into a more complex temperature-density relation, as is shown on Fig.~\ref{fig:T_rho}. The color map shows the mass weighted $T-\rho_{\mathrm{gas}}$ relation from our simulations and the grey contours show the case for uniform blazar heating with the same resolution \citep{2012MNRAS.423..149P}. Temperature measures the integrated impact of TeV blazar heating over time. When clustering is taken into account, the temperature-density relation has a significant scatter for underdense regions even when we use the galaxy bias model. For the quasar bias model, this scatter results in the lower envelope of the temperature-density relation to change little from the case with no blazar heating. However, the mode of the temperature is very close to the uniform blazar heating case. At $z=1$ the simulation with the galaxy bias model has a very similar outcome to the uniform model and blazar heating can be considered nearly homogeneous, though the lower envelope sits at a lower temperature.

The probability distribution function clearly highlights the impact of clustering on TeV blazar heating. Figure~\ref{fig:PDF} shows the mass-weighted probability distribution functions of the temperature for all the simulations. This provides a more quantitative view of the scatter in temperature. The simulation with the quasar bias model shows significant deviation from the uniform case, especially at lower redshifts. Here the effect of the lower envelope is clear as theres is a significant tail toward lower temperatures for $z \leqslant 3$. The scatter is stronger for the quasar bias mode, where the coldest zones have $T\simeq 10^4K$ while the warmest zones have $T\simeq 3\times 10^4K$ for $z=3$. Conversely, the warmest gas is only slightly warmer than the mode of the temperature. 

\begin{figure*}
\centering
\includegraphics[width = .42\textwidth ]{T_rho_z4_gal2_ok.png}
\includegraphics[width = .42\textwidth ]{T_rho_z4_qso4_ok.png}
\includegraphics[width = .42\textwidth ]{T_rho_z3_gal2_ok.png}
\includegraphics[width = .42\textwidth ]{T_rho_z3_qso4_ok.png}
\includegraphics[width = .42\textwidth ]{T_rho_z2_gal2_ok.png}
\includegraphics[width = .42\textwidth ]{T_rho_z2_qso4_ok.png}
\includegraphics[width = .42\textwidth ]{T_rho_z1_gal2_ok.png}
\includegraphics[width = .42\textwidth ]{T_rho_z1_qso4_ok.png}
\caption{Mass weighted temperature - density relation at $z=4,3,2,1$ (from top to bottom) for the simulations with galaxy bias (left) and the quasar bias (right). The overlying grey contours show the corresponding $T-\rho_{\mathrm{gas}}$ relation for uniform blazar heating \citep{2012MNRAS.423..149P} for the same mass range. }
\label{fig:T_rho}
\end{figure*}
\begin{figure}[h]
\centering
\includegraphics[width = .45\textwidth ]{full_PDF_256_gal_qso.pdf}
\caption{Volume-weighted temperature probability distribution function for $z=1$ (black), 2 (blue), 3 (cyan) and 4 (green) for the quasar bias model (solid line), galaxy bias model (dashed line) and the uniform case (dotted line). The peaks in the temperature distribution move towards higher temperatures as the redshift decreases.}
\label{fig:PDF}
\end{figure}
To have a better understanding of the heating fluctuations with respect to density fluctuations we plotted the mass-weighted $\delta_H-\delta_{\mathrm{gas}}$ distribution on Fig. \ref{fig:deltas}. The heating rate represents an instantaneous view of the impact of TeV blazar heating. In the quasar bias model (lower row), most of the particles receive slightly more heat than in the uniform case. However, the additional heat is only a few times more than the uniform case, while certain regions receive orders of magnitude less heat than the mean value. These areas suffer from the decrease of the TeV flux and isolation from massive structures. This is consistent with the temperature probability distribution function presenting a low temperature tail and a low probability for high temperatures. In the galaxy model, most of the gas is heated similarly to the uniform case, translating the lower bias for galaxies.
\begin{figure*}[h]
\centering
\includegraphics[width = .45\textwidth ]{delta_deltah_z1_gal2_ok.png}
\includegraphics[width = .45\textwidth ]{delta_deltah_z3_gal2_ok.png}\\
\includegraphics[width = .45\textwidth ]{delta_deltah_z1_qso4_512b.png}
\includegraphics[width = .45\textwidth ]{delta_deltah_z3_qso4_512b.png}
\caption{Volume-weighted distribution of heating rate fluctuations $(1+\delta_H)$ with respect to the density fluctuations $(1+\delta_{\mathrm{gas}})$ for the galaxy bias model (upper row) and the quasar bias model (lower row) at $z=3$ and $z=1$. The black dashed line represents the case of uniform blazar heating.}
\label{fig:deltas}
\end{figure*}
\section{Discussion}
Previous work on TeV blazar heating showed a significant increase in the temperature of the low density IGM \citep{2012ApJ...752...23C,2012MNRAS.423..149P}. These results, while in good agreement with observational data for the mean transmitted flux statistics as well as fits to individual lines, appear to be in potential tension with the recent work \citep{2012ApJ...757L..30R}. This observation suggest that a significant presence of gas in the IGM that has not been exposed to additional heating beyond photoheating. In the context of blazar heating, this suggests that the heating is not entirely uniform. In this work, we have studied the impact of inhomogeneous heating and find that when accounting for the clustering of sources, the variability in the heating rate is significant. In particular, we find that while most of the gas receives close to average heating, and has a temperature close to the uniform heating case, there is an important scatter in the temperature of the gas. If confirmed with the analysis of the resulting Lyman $\alpha$ forest, our model is able to account for both the observed increase in temperature in the low density IGM \citep{2014MNRAS.441.1916B,2009MNRAS.399L..39V} and the lower values of the line widths as suggested by \citet{2012ApJ...757L..30R}.

The impact of inhomogeneous heating becomes especially important after $z=2.5$. At such redshift, the impact of HeII reionization on the temperature of the IGM is limited \citep{2013MNRAS.435.3169C}. An increased temperature, with a strong scatter in underdense regions can then be attributed to inhomogeneous blazar heating. 

Direct measurements of the low density IGM are hard to obtain as the Lyman $\alpha$ forest is sensitive to overdensities of at least a few. The Lyman $\alpha$ forest of HeII traces lower density regions and is a promising observable, with more data becoming available \citep{2014arXiv1405.7405W}.

%A good understanding of the IGM is crucial as it is the birthplace of the large scale structures we observe. TeV blazar heating increases its average temperature and entropy, even at early times, and will impact the formation and evolution of structures \citep{2012ApJ...752...24P}. Such heating occurs far away from the sources and is complimentary to other black hole feedback mechanisms directly impacting their host galaxies and clusters.

Our model neglects important physical aspects of TeV blazars such as their duty cycle and beaming of the gamma-ray emission. The $\gamma$-ray duty cycle of BL Lac objects is of order of 10 $\%$ \citep{1996ApJ...464..600S}. As TeV blazars have low accretion rates, their lifetime is long $\simeq 5-7$ Gyr \citep{2002ApJ...571..226C}. The $\gamma$ ray sources are highly beamed, with observed opening angles peaking around 20$^{\circ}$ \citep{2009A&A...507L..33P}. Parsec scale VLBI observations of the inner parts of radio jets indicate variations of the position angle of around 20$^{\circ}$, up to 120$^{\circ}$ over more than a decade \citep{2013AJ....146..120L}. Assuming the gamma-ray emission follows the orientation of the radio jet, the rapid variability of the sources can potentially increase the scatter in the heating rate. Indeed, in the early universe, when few sources are present,  individual variability increases the inhomogeneity of blazar heating. In such case, our model is a lower limit for the associated heating rate fluctuations. However, later on, as the number of sources at a  given point increases, the variability of the heating rate will be reduced.    On top of the intrinsic  variability  of the sources, shot noise, which becomes important when sources are rare, is not taken into account and will result in additional heating rate fluctuations. For instance, at $z \sim 1-2$, the number of sources that contributes half the heating is $\approx 10$ whereas at $z = 3$, it dwindles to $\approx 1$ \citep{2012ApJ...752...23C}.   While this would suggest that the shot noise is potentially large, this is mitigated somewhat by the fact that the next 25\% of the heating is provided by $\approx 100$ sources between $z=1-2$ and $\approx 10$ source at $z=3$. 
%\ALc{[{ \em Phil, could you add a few sentences on the number of sources at difference redshifts here?}]}. 
\Pc{Hence, the fluctuations that we calculate in this work are likely a lower limit.}

Our model is based on quasar bias, which is likely lower than TeV-blazar bias \citep{2014arXiv1410.0358A}. Radio loud AGN are associated with red giant elliptical galaxies \citep{2007A&A...476..723H} and are often at the center of small clusters and groups. Quasars have a wider distribution of host galaxies and are rarely found at the center of clusters. Therefore, the scatter found in our simulations at low redshift is probably a lower limit to the exact scatter. In our simulations, any dense source emits TeV photons, regardless of the type of galaxy, and history of merger, accretion or star formation. The difference in the median temperature and standard deviation between the galaxy and quasar bias model is less than $5\%$ which is smaller than current observational precision.
\section{Conclusions}
In this paper we have implemented inhomogeneous TeV blazar heating into cosmological simulations to study the impact of clustering on the thermal state of the intergalactic medium. This extends the work by \citet{2012ApJ...752...23C,2012MNRAS.423..149P}, based on uniform blazar heating.

We developed a filtering function relating heating rate fluctuations to the linear dark matter fluctuations. Using this window function, we are able to model the relevant length scales for the blazar heating fluctuations and include them in a statistical fashion. Our method is a cost effective alternative method to fully self consistent simulations of blazar heating where modeling black hole formation and growth and complete radiative transfer would have been prohibitive.

Using this model for heating fluctuations, we find that large underdense regions receive less than one percent of the average heating rate while highly clustered regions receive up to five times more than the average heating rate at $z=1$. Still, as in the uniform case, the impact of TeV blazar heating is the strongest in low density regions. In our simulations, the mode of the temperature of the IGM is very close to the value in the uniform model, indicating the uniform model is a good zeroth order approximation. However, the temperature-density relations we obtain present a much larger scatter than the uniform case, especially at low redshift. In our quasar bias model, the temperature at mean density varies by an order of magnitude between the coldest and warmest regions.

Our model for the blazar heating fluctuations yields a temperature-density relation which can potentially reconcile the observed increased mean temperature of the IGM \citep{2014MNRAS.441.1916B}, while maintaining a fraction of cold gas, responsible for the lower envelope of the linewidth distribution \citep{2012ApJ...757L..30R}. Therefore, detailed modeling of the Lyman $\alpha$ forest will be the subject of a forthcoming paper. If confirmed, this will clearly indicate a more complex thermal history of the IGM, with potentially an important impact on late forming structures.
\begin{acknowledgements}
AL and PC are supported by the UWM Research Growth Initiative, the NASA ATP
program through NASA grant NNX13AH43G, and NSF grant AST-1255469.
A.E.B.~and M.S.~receive financial support from the Perimeter
Institute for Theoretical Physics and the Natural Sciences and
Engineering Research Council of Canada through a Discovery Grant.
Research at Perimeter Institute is supported by the Government of
Canada through Industry Canada and by the Province of Ontario through
the Ministry of Research and Innovation.
C.P.~gratefully acknowledges
financial support of the Klaus Tschira Foundation. E.P. acknowledges support by the ERC grant ``The Emergence of Structure during the epoch of Reionization''.
The authors acknowledge the Texas Advanced Computing Center (TACC) at The University of Texas at Austin and the NASA Advanced Supercomputing Division for providing HPC resources that have contributed to the research results reported within this paper.
\end{acknowledgements}
\appendix
We detail the derivation of the window function of Eq.~\eqref{eq:window}. We start from a purely Newtonian universe, then include the impact of expansion and finally various first order corrections to the received TeV flux.\\

\section {Newtonian case}\label{sec:windon_newt}
\subsection {Fluctuations with respect to the mean heating rate}

%\Cc{[{\em I edited almost every equation in App. A: some were cosmetic changes to unify the notation, some to streamline the presentation and correcting typos. Please check carefully!}]}
%\ALc{[{\em I changed photons to ergs and remove $E_0$ to have consistency with main text. I also replaced $n_{EBL} \sigma$ by $1/D_{pp}$ because that is what I actually used. I just did Appendix A so far.  }]}
The TeV flux received (in erg s$^{-1}$ cm$^{-2}$) at position $\mathbf{x}$, at a given energy, is given by the sum over all the sources within a radius $r\leqslant r_{\mathrm{max}}$.
\begin{equation}
  \label{eq:flux_recu0}
  J(\mathbf{x})=
  \int_{0}^{2\pi}d\phi\int_{0}^{\pi}\sin\theta d\theta\int_0^{r_{\mathrm{max}}}|\mathbf{x}'-\mathbf{x}|^2 d(\mathbf{x}'-\mathbf{x})
  \frac{\mathcal{E}(\mathbf{x}') }{4\pi |\mathbf{x}'-\mathbf{x}|^2} e^{-\tau}
  =\int_{\Omega} d\Omega\int_0^{r_{\mathrm{max}}} dr' \frac{\mathcal{E}(\mathbf{r}'+\mathbf{x}) }{4\pi } e^{-\tau},
\end{equation}
where the emissivity $\mathcal{E}$ is an energy per unit time, per unit volume, $\tau=\kappa (\mathbf{x}'-\mathbf{x})$ is the optical depth along the line of sight, and $\kappa$ the absorption coefficient. In the last step, we introduced $\mathbf{r'}=\mathbf{x}'-\mathbf{x}$ and $d\Omega=\sin\theta d\theta d\phi$. The differential heating rate is defined as $d\dot{Q}(\mathbf{x})\equiv dJ(\mathbf{x})/D_{\mathrm{pp}}$ such that the volume-integrated heating rate $\dot{Q}$ and its average (in units of erg cm$^{-3}$ s$^{-1}$) are given by 
\begin{equation}
  \label{eq:heating_rate0}
  \dot{Q}(\mathbf{x})=
  \frac{1}{4\pi}   \int_{\Omega}d\Omega\int_0^{r_{\mathrm{max}}} dr' \mathcal{E}(\mathbf{r}'+\mathbf{x}) \frac{1}{D_{\mathrm{pp}}} e^{-\tau},\quad\mbox{and}\quad
  \bar{\dot{Q}}= \frac{1}{4\pi}   \int_{\Omega}d\Omega\int_0^{r_{\mathrm{max}}} dr' \bar{\mathcal{E}} \frac{1}{D_{\mathrm{pp}}} e^{-\tau},
\end{equation}
where $D_{\mathrm{pp}}$ is the mean free path before the gamma-rays pair-produce, which is constant over the volume.
The heating rate fluctuations at a given point $\mathbf{x}$ are then given by 
\begin{eqnarray}
  \label{eq:heat_fluc_newt0}
  \delta_H(\mathbf{x})&=&\frac{\dot{Q}(\mathbf{x})-\bar{\dot{Q}}}{\bar{\dot{Q}}}=
  \frac{1}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}} \int_{\Omega}d\Omega\int_0^{r_{\mathrm{max}}} dr' 
  [\mathcal{E}(\mathbf{r}'+\mathbf{x})-\bar{\mathcal{E}}]e^{-\tau} \nonumber\\
  &=&\frac{1}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}}\int_{\Omega}d\Omega\int_0^{r_{\mathrm{max}}} dr' \delta_E(\mathbf{r}'+\mathbf{x})\bar{\mathcal{E}}\,e^{-\kappa r'} ,
\end{eqnarray}
where $\delta_E$ are the fluctuations of the TeV photon emissivity.


% 

\subsection{Window function}
As the universe is infinite and asymptotically flat, we can expand the fluctuations into planar waves, in order to get the length scale dependence of heating rate fluctuations,
\begin{eqnarray}
  \label{eq:FT_delta}
  \delta_H(\mathbf{x})&=&\frac{1}{(2\pi)^3}\int_{-\infty}^{\infty} d^3\mathbf{k'} \tilde{\delta}_H(\mathbf{k'}) e^{-i\mathbf{k'}\cdot\mathbf{x}},\\ \nonumber
  \delta_E(\mathbf{r}'+\mathbf{x})&=&\frac{1}{(2\pi)^3}\int_{-\infty}^{\infty} d^3\mathbf{k'} \tilde{\delta}_E(\mathbf{k'}) e^{-i\mathbf{k'}\cdot(\mathbf{r'}+\mathbf{x})}.
\end{eqnarray}
\ALc{Performing a convolution of the density fluctuations with the kernel $C r^{-2} e^{-r/D_{\mathrm{pp}}}$ (with C an arbitrary constant), and using the Fourier convolution, Eq. \ref{eq:heat_fluc_newt0} rewrites}
%Eq. (A4) is simply a convolution of the density fluctuations with the kernel $C exp^{(-r/Dpp)}/r^2$, and thus via the Fourier convolution theorem (Bracewell) this implies
 \begin{equation}
   \label{eq:1}
\tilde{\delta}_H(k) = \tilde{\delta}_E(k) \tilde{W}(k)   ,
 \end{equation}

where $\tilde{W}(k)$ is the Fourier transform of $C  r^{-2} e^{(-r/D_{\mathrm{pp}})}$. This yields


% Eq.~\eqref{eq:heat_fluc_newt0} then gives
% \begin{equation}
%   \label{eq:heat_fluc_newt1}
%   \delta_H(\mathbf{x})
%   =\frac{1}{(2\pi)^3}\int_{-\infty}^{\infty} d^3\mathbf{k'} \tilde{\delta}_H(\mathbf{k'}) e^{-i\mathbf{k'}\cdot\mathbf{x}}
%   =\frac{1}{ (2\pi)^3}\frac{1}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}} \int_{\Omega}d\Omega\int_0^{r_{\mathrm{max}}}  dr' \bar{\mathcal{E}} e^{-\kappa r'} \int d^3\mathbf{k'} \tilde{\delta}_E(\mathbf{k'}) e^{-i\mathbf{k'}\cdot(\mathbf{r'}+\mathbf{x})}.
% \end{equation}
% Performing an inverse Fourier transform of Eq.~\eqref{eq:heat_fluc_newt1} yields
% \begin{eqnarray}
%   \label{eq:heat_fluc_newt2}
%   \tilde{\delta}_H(\mathbf{k})&=& \frac{1}{(2\pi)^3} \frac{1}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}}\int_{\Omega}d\Omega\int_0^{r_{\mathrm{max}}} dr' \bar{ \mathcal{E}} e^{-\kappa r'} \int d^3\mathbf{k'}\int d^3\mathbf{x} \tilde{\delta}_E(\mathbf{k'})e^{-i\mathbf{k'}\cdot{\mathbf{r}'}} e^{i(\mathbf{k}-\mathbf{k'})\cdot\mathbf{x}} \\ \nonumber
%   &=&\frac{1}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}} \int_{\Omega}d\Omega\int_0^{r_{\mathrm{max}}}   dr' \bar{\mathcal{E}}  e^{-\kappa r'} \int d^3\mathbf{k'} \delta^{0}(\mathbf{k}-\mathbf{k}')\tilde{\delta}_E(\mathbf{k'}) e^{-i\mathbf{k'}\cdot{\mathbf{r}'}}  \\ \nonumber
%   &=&\frac{1}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}} \int_{\Omega}d\Omega\int_0^{r_{\mathrm{max}}}  dr' \bar{ \mathcal{E}} e^{-\kappa r'}  \tilde{\delta}_E(\mathbf{k}) e^{-i\mathbf{k}\cdot{\mathbf{r}'}}  ,
% \end{eqnarray}

\begin{equation}
  \label{eq:heat_fluc_newt2}
  \tilde{\delta}_H(\mathbf{k})=\frac{1}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}} \int_{\Omega}d\Omega\int_0^{r_{\mathrm{max}}}  dr' \bar{ \mathcal{E}} e^{-\kappa r'}  \tilde{\delta}_E(\mathbf{k}) e^{-i\mathbf{k}\cdot{\mathbf{r}'}}  ,
\end{equation}

where $\delta^{(0)}$ denotes the Dirac delta distribution. Introducing $\mu=\cos\theta$, where $\theta$ is the angle between the wave vector and the line of sight, and assuming statistical isotropy and homogeneity, Eq.~\eqref{eq:heat_fluc_newt2} can be simplified as follows,
\begin{eqnarray}
  \label{eq:heat_fluc_newt3}
  \tilde{\delta}_H(k)&=&  
  \frac{1}{2\bar{\dot{Q}}D_{\mathrm{pp}}} \int_{-1}^{1} d\mu \int_0^{r_{\mathrm{max}}}dr'  \bar{\mathcal{E}} e^{-\kappa r'} \tilde{\delta}_E(k) e^{-ikr'\mu}
  =\tilde{\delta}_E(k)\frac{\bar{\mathcal{E}}}{D_{\mathrm{pp}}} {\bar{\dot{Q}}}\int_0^{r_{\mathrm{max}}} \frac{\sin(kr')}{kr'} e^{-\kappa r'}   dr'\\ \nonumber
 &=&\tilde{\delta}_E(k)\frac{\bar{\mathcal{E}}}{ D_{\mathrm{pp}}\bar{\dot{Q}}k} \arctan\left(\frac{k}{\kappa}\right)
  =\tilde{\delta}(k)\frac{\bar{\mathcal{E}}}{D_{\mathrm{pp}} \bar{\dot{Q}}k} \arctan\left(\frac{k}{\kappa}\right).\\ 
\end{eqnarray}
In the last step, we have assumed that the fluctuations in the TeV emissivity follow the DM density fluctuations, i.e., $\delta_E=\delta$. 
Figure~\ref{fig:window_newt} shows  window functions with different absorption coefficients in a purely Newtonian universe. The solid red line shows a case with no absorption, the dashed green line shows a case with $\kappa=10$ Mpc$^{-1}$.  In the former case, large scale structure has the strongest impact on heating, as larger regions have more sources. When absorption is present,  the impact of large scale structure (i.e. low wave numbers $k$) remains constant as distant sources are absorbed. For scales equal to or larger than the cutoff, heating fluctuations follow density fluctuations and overdense regions get more heat. At smaller scales, the density structure has less impact on the heating, unless a strong overdensity is present.  

\begin{figure}
\centering
% \includegraphics[width = .45\textwidth ]{newtonian_window}
\includegraphics[width = .45\textwidth ]{newtonian_window}
\caption{Window function for a non-expanding universe. The solid red line has very little absorption ($\kappa=10^{-2}$ Mpc$^{-1}$), the dashed green line has $\kappa=10 $ Mpc$^{-1}$ .}
\label{fig:window_newt}
\end{figure}


\section{Expanding universe}\label{sec:window_exp}

The heating rate of an arbitrary point defined as the origin at redshift $z$ is given by 
\begin{equation}
  \dot{Q}(z)= \int_{E_{\rm min}}^{E_{\rm max}} dE \frac{J_E(E, z)}{D_{\mathrm{pp}}(E, z)},
\end{equation}
where $J_E$ is the specific intensity at the origin, $E_{\mathrm{min}}$ to $E_{\mathrm{max}}$ is the range over which pair production is possible. Its evolution is dictated by the equation of radiative transfer in an expanding universe
\begin{equation}\label{eq:radiative transfer}
  \frac{\partial J_E}{\partial t} - E H \frac{\partial J_E}{\partial E} + 3 H J_E + c\kappa J_E  = \frac {c}{4\pi} \epsilon,
\end{equation}
where $H = \dot{a}/a$ is the Hubble parameter, $a$ is the scale factor, $\kappa$ is the , and $\epsilon$ is the proper emissivity.  Integrating equation (\ref{eq:radiative transfer}) over all lines of sight and averaging, we find 
\begin{equation}\label{eq:expanding J}
  J_E(E, z) = \frac {(1 + z)^3} {4\pi D_{\mathrm{pp}}} \int_z^{z_{\mathrm{max}}} \frac{dr}{dz'} dz' {\mathcal{E}(E',z')}e^{-\tau(E,z,z')},
\end{equation}
where $r$ is the comoving distance, $\mathcal{E} = \epsilon/(1+z')^3$ is the comoving emissivity, $E' = E (1+z')/(1+z)$ and $\tau$ is the approximate optical depth given by
\begin{equation}
\label{eq:tau}
\tau(E,z,z')\equiv \tau=\frac{1}{D_{\mathrm{pp}}(E,z)}\int_z^{z'}dz''\frac{dr}{dz''}.%=\int_z^{z'}dz''\frac{c}{H(z'')}\frac{1}{D_{\mathrm{pp}}},
\end{equation}
An alert reader will recognize that the true optical depth must include the effect of a changing $D_{\rm pp}$ as we integrate from $z$ to $z'$.  Here we make the assumption that $\tau(E',z,z') \propto r$, where $r(z,z')$ is the proper distance between the origin at $z$ and another point at $z'$ to 
derive equation (\ref{eq:expanding J}). This assumption holds because the typical mean free paths for high energy photons are much smaller than the Hubble length.  Hence $E' \approx E$ as the redshift interval over which integrand is nontrivial is small compared to $z$.  
We then find that the energy-integrated,  volume-integrated heating rate is then given by 
\begin{equation}
  \label{eq:int_exp_heat}
  %\dot{Q}(z)=\frac{(1+z)^3}{4\pi}\int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE\int_{\Omega}d\Omega\int_z^{z_{\mathrm{max}}} dz'\frac{dr}{dz'}\frac{\mathcal{E}(E',z')}{D_{\mathrm{pp}}(E',z')} e^{-\tau(E',z,z')},
  \dot{Q}(z)=\frac{(1+z)^3}{4\pi }\int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} \frac{dE}{D_{\mathrm{pp}}(E,z)}\int_{\Omega}d\Omega\int_z^{z_{\mathrm{max}}} dz'\frac{dr}{dz'}\mathcal{E}(E',z') e^{-\tau(E,z,z')},
\end{equation}
%\sout{
%where $z'$ is the redshift at which the photons are emitted. Switching to comoving distances yields $(1+z)^2$ for the dilution of the area and another $(1+z)$ to account for the shift in energy. $\mathcal{E}$ is the %comoving emissivity and $D_{\mathrm{pp}}$ the comoving mean free path.  
%Both depend on the energy  and redshift  of the emitted photon. For convenience reasons, we do not explicit these dependencies in the following derivation.  We perform an integral over the energy $E$  at which pair production is possible, extending from $E_{\mathrm{min}}$ to $E_{\mathrm{max}}$. To have an adequate energy $E$ at redshift $z$, a photon is emitted with energy $E'$ at redshift $z'$ such that
%}
%$\mathcal{E}(E',z')$ is the blazar luminosity at the energy $E'$, which then redshifts to energy $E$ following 
%\begin{equation}
%\label{eq:E_z}
%E'=E\frac{1+z'}{1+z}.
%\end{equation}
%\sout{Similarly, $\tau(E,z,z')$ is the optical depth of a TeV photon observed at redshift $z$ with energy $E$, which was emitted at redshift $z'$ with energy $E'$.}
%\begin{equation}
%\label{eq:tau}
%\tau(E,z,z')\equiv \tau=\int_z^{z'}dz''\frac{1}{D_{\mathrm{pp}}}\frac{dr}{dz''}.%=\int_z^{z'}dz''\frac{c}{H(z'')}\frac{1}{D_{\mathrm{pp}}},
%\end{equation}

%}
%\ALc{[{\em Phil, this may be a good place to discuss that $\kappa \simeq $ constant}]}

Similarly to Eq.~\eqref{eq:heating_rate0}, the mean heating rate is given by
\begin{equation}
\label{eq:mean_exp_heat}
\bar{\dot{Q}}=\frac{(1+z)^3}{4\pi}\int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE\int_{\Omega}d\Omega\int dz' \frac{dr}{dz'}\frac{\bar{\mathcal{E}}}{D_{\mathrm{pp}}} e^{-\tau}.
\end{equation}

\begin{eqnarray}
\label{eq:fluc_exp0}
\delta_H(z)&=&\frac{\dot{Q}(z)-\bar{\dot{Q}}}{\bar{\dot{Q}}}=\frac{(1+z)^3c}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}} \int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE\int_{\Omega}d\Omega\int_z^{z_{\mathrm{max}}} dz'\frac{ ( \mathcal{E}(z')-\bar{\mathcal{E}}) e^{-\tau}}{H(z')} \\ \nonumber
&=&\frac{(1+z)^3 c}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}} \int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE\int_{\Omega}d\Omega\int_0^{z_{\mathrm{max}}} dz' \frac{\bar{\mathcal{E}}\delta_E(z') e^{-\tau}}{H(z')},
\end{eqnarray}

The TeV emission is related to the presence of supermassive black holes at the center of galaxies, which are located in collapsed dark matter halos. We can thus connect the fluctuations of the TeV emission, within a certain radius $r$, to the underlying dark matter fluctuations $\delta$.
At this stage we assume the TeV fluctuations exactly match the dark matter fluctuations $\delta_E=\delta$. We explain in the next section that this is not exactly true and will take into account various corrections. The initial density fluctuations represent a Gaussian random field, which exact properties depend on the earliest stages of the Universe prior to recombination \citep{1986ApJ...304...15B,Peebles}. They grow linearly between $z'$ and $z$ following $\delta(z',r)=\delta_0(r)D(z')/D(z)$ \citep{ 1977MNRAS.179..351H}, where the linear growth factor is given by
\begin{equation}
\label{eq:growth_1}
D(z)=D_0H(z)\int_z^{\infty}dz'\frac{1+z'}{H^3(z')}.
\end{equation}
The linear approximation breaks down when the amplitude of the root mean square of the perturbations approaches unity. The evolution of the density field is then determined by the spherical collapse \citep{1972ApJ...176....1G} and the virialization of halos. As the growth of the modes is independent of the wavenumber, we have
\begin{equation}
\label{eq:FT_delta}
\delta_E(z',r)=\delta(z',r)=\delta_0(r)D(z')=\delta_0D(z')\frac{1}{(2\pi)^3}\int d^3\mathbf{k'} \tilde{\delta}(\mathbf{k'}) e^{-i\mathbf{k'}\cdot\mathbf{r}}.
\end{equation}
And Eq.~\eqref{eq:fluc_exp0} rewrites as
\begin{equation}
\label{eq:heat_fluc_exp0}
\delta_H(z)=\frac{(1+z)^3  c}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}}\int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE \int_{\Omega}d\Omega\int_z^{z_{\mathrm{max}}}dz' \frac{D(z')}{D(z)} \frac{\bar{\mathcal{E}}\delta(r') e^{-\tau}}{H(z')}.
\end{equation}
The left hand side yields $\tilde{\delta}(\mathbf{k})$ while the right hand side transforms in a similar fashion to Eq.~\eqref{eq:heat_fluc_newt3}. As the power spectrum of density fluctuations is isotropic, this yields
\begin{equation}
\label{eq:heat_fluc_exp1}
\tilde{\delta}_H(k)=\tilde{\delta}(k) \frac{(1+z)^3c}{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}} \int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE\int_z^{z_{\mathrm{max}}} dz' \frac{D(z')}{D(z)}\frac{\sin(kr'(z'))}{kr'(z')} \frac{\bar{\mathcal{E}}e^{-\kappa r'(z')}} {H(z')}.
\end{equation}
\begin{figure}[h]
\centering
% \includegraphics[width = .45\textwidth ]{window_nobiases}
\includegraphics[width = .45\textwidth ]{window_nobiases-eps-converted-to}
\caption{Window function in an expanding universe.}
\label{fig:window_nobiases}
\end{figure}
Fig. \ref{fig:window_nobiases} shows the window function in an expanding universe at different redshifts. %Comparing with non-expanding case in Fig. \ref{fig:window_newt} \textit{ blabla}
The TeV emission fluctuations are not exactly equal to the dark matter density fluctuations. In the next section we will account for the various corrections that have to be taken into account to determine a more accurate window function.
\section{Complete window function}
The TeV fluctuations are biased with respect to the dark matter fluctuations, as we detail in $\S$\ref{sec:window}, yielding
\begin{equation}
\delta_E=[1+b(z)]\delta
\label{eq:bias}
\end{equation}
On top of that, the emitting area (which corresponds to the proper area), evolves as
\begin{equation}
\label{eq:emitting_area}
4\pi r(z)^2=4\pi r^2\left(\frac{\bar{\rho}}{\rho(z)}\right)^{2/3}=4\pi r^2(\delta(z)+1)^{2/3}.
\end{equation}
A small density perturbation thus gives
\begin{equation}
\label{eq:pert_area}
dA\simeq 4\pi \left(1+\frac{2}{3}\delta\right)r^2.
\end{equation}
If galaxies were moving exactly with the Hubble flow, their redshift would yield their exact distance to an observer. However, galaxies bound to the central potential of a cluster have an infall velocity towards the central overdensity. The proper distance to a source then becomes
\begin{equation}
\label{eq:vel_perturb}
dz'=dr\frac{H(z')}{c}\left(1-\frac{d\delta_{v_r}(z')}{dr}\right),
\end{equation}
where $\delta_{v_r}$ are the velocity perturbations along the line of sight. The Fourier transform of $\delta_{v_r}$ gives \citep{1987MNRAS.227....1K}.
\begin{equation}
\label{eq:kaiser2}
\mathcal{F}\left(\frac{d\delta_{v_r}}{dr}\right)=-\mu^2\tilde{\delta}(\mathbf{k}),
\end{equation}
with $\mu$ the cosine of the angle between the wavenumber and the line of sight.
Keeping only first order correction for density fluctuations, Eq.~\eqref{eq:int_exp_heat} yields
\begin{equation}
\label{eq:mean_heat0}
\dot{Q}(z)=\frac{(1+z)^3c}{4\pi D_{\mathrm{pp}}}\int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE\int_{\Omega}d\Omega\int_z^{z_{\mathrm{max}}} dz'\mathcal{\bar{E}}\frac{D(z')}{D(z)}\left(1+\left(b(z)+\frac{2}{3}\right) \delta(r) -\frac{d\delta_{v_r}}{dr}\right).
\end{equation}
Subtracting the mean heating rate (Eq.~\eqref{eq:mean_exp_heat}) then yields the fluctuations
\begin{equation}
\label{eq:heat_fluc0}
\delta_H(z)=\frac{1}{X}\int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE\int_{\Omega}d\Omega\int_z^{z_{\mathrm{max}}}dz'\frac{dX}{dz'}\frac{D(z')}{D(z)}\left(\left(b(z)+\frac{2}{3}\right) \delta(r) -\frac{d\delta_{v_r}}{dr}\right),
\end{equation}
where we introduced
\begin{equation}
\label{eq:def_X}
\frac{dX}{dz'}=\frac{(1+z)^3c}{4\pi D_{\mathrm{pp}}}\frac{\mathcal{\bar{E}}e^{-\tau}}{H(z')},
\end{equation}
for convenience reasons and to highlight the generality of the method.
Switching to $k$-space then yields
\begin{eqnarray}
\label{eq:heat_fluc0}
\tilde{\delta}_H(k)&=&\frac{1}{X}\int_{\Omega}d\Omega\int_z^{z_{\mathrm{max}}} dz'\frac{dX}{dz'}\frac{D(z')}{D(z)}\left(\left(b(z)+\frac{2}{3}\right) \delta(\mathbf{r'}+\mathbf{x}) -\frac{d\delta_{v_r}(\mathbf{r'}+\mathbf{x})}{dr}\right)\\ \nonumber
&=&\frac{1}{X}\int_{\Omega}d\Omega\int_z^{z_{\mathrm{max}}} dz'\frac{dX}{dz'}\frac{D(z')}{D(z)}\Biggl(\left(b(z)+\frac{2}{3}\right) \int d^3\tilde{\delta}(\mathbf{k})'\delta^{(0)}(\mathbf{k}-\mathbf{k'})e^{-i\mathbf{k}' \cdot \mathbf{r}'}\tilde{\delta}(\mathbf{k}')- \int d^3\mathbf{k}'e^{-\mathbf{k}'\cdot \mathbf{r}'}\delta(\mathbf{k}')\delta^{(0)}(\mathbf{k}+\mathbf{k}')\mu^2 \Biggr) \\ \nonumber
&=&\frac{\tilde{\delta}(\mathbf{k})}{X}\int_{-1}^{1}d\mu\int_z^{z_{\mathrm{max}}} dz'\frac{dX}{dz'}\frac{D(z')}{D(z)}\Biggl(\left(b(z)+\frac{2}{3}\right)+\mu^2\Biggr) e^{-ikr\mu} \\ \nonumber
&=&\frac{\tilde{\delta}(\mathbf{k})}{X}\int_z^{z_{\mathrm{max}}}dz'\frac{dX}{dz'}\frac{D(z')}{D(z)}\left((b(z)+1)j_0(kr)-\frac{2}{3}j_2(kr)\right).
\end{eqnarray}
With the spherical Bessel functions
\begin{eqnarray}
\label{eq:bessel}
j_0(kr)&=& \frac{\sin(kr)}{kr}\\
j_2(kr)&=& \left(\frac{3}{x^2}-1\right)\frac{\sin(x)}{x}-\frac{3 \cos(x)}{x^2} .
\end{eqnarray}
We have used
\begin{equation}
\label{eq:bes2}
\int_{-1}^{1}\mu^2 e^{i k r \mu} d\mu=\frac{2 \sin(kr)}{kr}+4\frac{\cos(kr)}{(kr)^2}-4\frac{\sin(kr)}{(kr)^3}.
\end{equation}
The window function for the heating rate fluctuations is then given by
\begin{eqnarray}
\label{eq:heat_fluc}
\tilde{W}_H(k,z)&=&\frac{(1+z)^3c }{4\pi\bar{\dot{Q}}D_{\mathrm{pp}}}\int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE\int_z^{z_{\mathrm{max}}} dz' \frac{\mathcal{\bar{E}}e^{-\tau}}{H(z')}\frac{D(z')}{D(z)}\left((b(z)+1)j_0(kr)-\frac{2}{3}j_2(kr)\right)\\
&=& \frac{\displaystyle \int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE\int_z^{z_{\mathrm{max}}} dz'   \frac{\mathcal{\bar{E}}e^{-\tau}}{H(z')}\frac{D(z')}{D(z)}\left((b(z)+1)j_0(kr)-\frac{2}{3}j_2(kr)\right)}{\displaystyle \int_{E_{\mathrm{min}}}^{E_{\mathrm{max}}} dE\int_z^{z_{\mathrm{max}}} dz'  \mathcal{\bar{E}} \frac{e^{-\tau}}{H(z')}}.
\end{eqnarray}
Which is the consisted with the window  function in \citet{2007MNRAS.376.1680P,2005ApJ...626....1B}.
\bibliographystyle{apj}
\bibliography{biblio_total}
\end{document}